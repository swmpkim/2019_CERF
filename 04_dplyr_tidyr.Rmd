---
title: "Working With Data in dplyr and tidyr"
author: "Kim Cressman"
date: "10/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE, warning = FALSE}
library(dplyr)
library(tidyr)
library(here)
```


Sometimes, the data we're working with is not quite ready for whatever it is we want to do. We may need to summarize the data based on some group, calculate additional parameters, subset the data, or even completely reshape it. The packages `dplyr` and `tidyr` can help with these tasks!  

# dplyr verbs, using ebird data  

First, let's read in the ebird data and remind ourselves what's in it:  

```{r}
ebird <- read.csv(here::here("data", "eBird_workshop.csv"), stringsAsFactors = FALSE)
glimpse(ebird)
```


## Choose _rows_: `filter()`  

This has a lot of rows. We might only be interested in observations about a single bird, which means we want to choose rows. To do this, we use the verb `filter()`:  

```{r}
ebird_AK <- ebird %>% 
        filter(state == "AK")
# equivalent to: filter(ebird, state == "AK")
glimpse(ebird_AK)
```

Notice a couple things here:  

+  We use `==` to specify an exact condition. If we were working with numbers, we could use:  
    +  `<`  
    +  `<=`  
    +  `==`  
    +  `!=` (**not** equal to)  
    +  `>=`  
    +  `>`  
+  The condition specified inside `filter()` MUST return either true or false, for each row.  


### multiple conditions  

We can filter based on more than one criterion, e.g. if we want all birds from Alaska, but only in the year 2008:  

```{r}
ebird_AK_2008 <- ebird %>% 
        filter(state == "AK",
               year == 2008)
glimpse(ebird_AK_2008)
```


**Note**: It doesn't matter if you select `state` or `year` first - you can do either.  

Because we're just experimenting with filtering here, and don't really need to save these as data frames in our environment, I'm going to stop assigning to objects and start doing this:  

```{r}
ebird %>% 
        filter(state == "AK",
               year == 2008) %>% 
        glimpse()
```

Note, that's not something you want to do if you actually need to work with the data frame later!  

***

### mini-challenge 1  

How could we pull out birds in Alaska (AK), before 2010? (Hint: you can use the same symbols that you would to filter numbers)  

```{r}

```

***  

### multiple conditions, cont.  

What if we want to look at birds from more than one state? There are a few ways to do this. 

Perhaps the easiest is to make a vector of the states you're interested in:  

```{r}
my_states <- c("AK", "AL", "MS")
```

And then use `%in%` in the filter statement, to say, e.g. "any of the states in this vector": 
```{r}
ebird_mystates <- ebird %>% 
        filter(year == 2008,
               state %in% my_states) %>% 
        glimpse()
# make sure the states we named, and only the states we named, are represented:
unique(ebird_mystates$state)
```

You could also skip the step of naming the vector separately:  

```{r}
ebird %>% 
        filter(year == 2008,
               state %in% c("AK", "AL", "MS")) %>% 
        glimpse()
```


### mini-challenge 2  

How would you filter the data to contain only the species "American Coot" from MS and AL (your instructors' states), in all years *except* 2010? Assign this object to a data frame and verify (using `unique()`) that you did it right.    

```{r}

```


***
***


## Choose _columns_: `select()`  

When you're working with a lot of data, you may not want or need to keep all the columns you started with. In this case, `select()` is what you need.

The ebird data frame doesn't have too many columns, but that makes it easy to see exactly what we're doing! Let's pretend we only want to keep species, state, and year. We can do this two ways:  

First, by selecting the columns we **do** want to keep:  

```{r}
ebird %>% 
        select(species, state, year) %>% 
        glimpse()
```


Or second, by using a `-` in front of the columns we **don't** want to keep:  

```{r}
ebird %>% 
        select(-samplesize, -presence) %>% 
        glimpse()
```

Either of these can be really handy depending on what your original data frame looks like and what you're trying to do!  


Order **does** matter in `select()`; remember it didn't matter in `filter()`. In `select()`, selections are made in the order specified - so if you want to rearrange the columns of your data, you can do it with this command!  

```{r}
ebird %>% 
        select(year, state, species) %>% 
        glimpse()
```


You can also move just one or a few columns to the beginning by specifying it/them, and then `everything()` - it keeps all other columns, in their original order:  

```{r}
ebird %>% 
        select(year, everything()) %>% 
        glimpse()
```


### helper functions  

Sometimes you have a lot of columns that start with the same prefix, or that end with the same appended matter; maybe you want to keep all of them (or get rid of all of them). In these situations, you can use the helper functions `starts_with()` and `ends_with()`. See the `dplyr` cheatsheet for other possible helper functions.  

In our little example, let's keep columns whose names start with 's':  

```{r}
ebird %>% 
        select(starts_with("s")) %>% 
        glimpse()
```

Or columns that end with 'e':  

```{r}
ebird %>% 
        select(ends_with("e")) %>% 
        glimpse()
```



### mini-challenge 3  

From the ebird data, subset to only include the species American Coot, from the states FL, AL, and MS. Keep only the state, year, and presence columns. What is the proper order of operations in this case?  

```{r}

```


***  
***  

## Modifying data frames with `mutate()`  

It's easy to make a new variable out of other variables in the data frame using `mutate()`. This operates on rows. The following command multiplies the values in two columns together to generate a third column:    

```{r}
ebird_mutated <- ebird %>% 
    mutate(bird_count = samplesize * presence)
```


You can also do simple math on a column:  

```{r}
ebird %>% 
    mutate(log_samplesize = log(samplesize),
           samplesizex10 = 10 * samplesize) %>% 
    glimpse()
```


You can even use a column immediately after creating it!  

```{r}
ebird %>% 
    mutate(bird_count = samplesize * presence,
           mathed_count = bird_count / 10) %>% 
    glimpse()
```


### mini-challenge 4  

And now that we've started creating more columns, it might make sense to get rid of some old ones. How would you remove samplesize and presence from this data frame?  

```{r}
ebird %>% 
    mutate(bird_count = samplesize * presence,
           mathed_count = bird_count / 10) %>% 
    
    glimpse()
```




***  
*** 

## Group-wise operations with `group_by()` and `summarize()`  

Say we want to find out how many birds were seen by state in this dataset. We can do that. These operations are also great for lumping data into daily, monthly, or yearly averages (like our SWMP datasets).    

```{r}
ebird %>% 
    group_by(state) %>% 
    summarize(mean_presence = mean(presence, na.rm = TRUE),
              max_presence = max(presence, na.rm = TRUE)) %>% 
    glimpse()
```



We can also group by combinations of multiple variables:  

```{r}
ebird %>% 
    group_by(state, species) %>% 
    summarize(mean_presence = mean(presence, na.rm = TRUE),
              max_presence = max(presence, na.rm = TRUE)) %>% 
    glimpse()
```


You can also sort using `arrange()`. Let's put this in order by species, then state:  

```{r}
ebird %>% 
    group_by(state, species) %>% 
    summarize(mean_presence = mean(presence, na.rm = TRUE),
              max_presence = max(presence, na.rm = TRUE)) %>% 
    arrange(species, state) %>% 
    glimpse()
```


Or put it in order by `max_presence`:  

```{r}
ebird %>% 
    group_by(state, species) %>% 
    summarize(mean_presence = mean(presence, na.rm = TRUE),
              max_presence = max(presence, na.rm = TRUE)) %>% 
    arrange(max_presence) %>% 
    glimpse()
```


To go from highest to lowest instead:  

```{r}
ebird %>% 
    group_by(state, species) %>% 
    summarize(mean_presence = mean(presence, na.rm = TRUE),
              max_presence = max(presence, na.rm = TRUE)) %>% 
    arrange(desc(max_presence)) %>% 
    glimpse()
```



```{r}
ebird %>% 
    select(state, year, samplesize) %>% 
    distinct() %>% 
    glimpse()
```


### (not-so-) mini-challenge 5  
